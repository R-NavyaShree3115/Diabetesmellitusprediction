<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Health Plan</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='premium.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="logo"><i class="fa-solid fa-heartbeat"></i> CareConnect</div>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/healthplan" class="active">Health Plan</a></li>
                <li><a href="/progress">Progress</a></li>
                <li><a href="/alerts">Alerts</a></li>
                <li><a href="/doctorconnect">Doctor Connect</a></li> 
                <li><a href="/logout">Logout</a></li>
            </ul>
        </nav>
    </header>
    
    <div class="container">
        <h1 class="text-center"><i class="fa-solid fa-clipboard-list"></i> Your Personalized Health Plan</h1>
        <p class="plan-intro">Your plan is generated by our AI model based on your latest health metrics and risk assessment.</p>
        
        <div id="plans" class="plan-grid">
            <div class="plan-box">
                <h2><i class="fa-solid fa-bowl-food"></i> Diet Plan</h2>
                <ul id="dietPlan"><li>Loading...</li></ul> 
            </div>
            <div class="plan-box">
                <h2><i class="fa-solid fa-person-running"></i> Exercise Plan</h2>
                <ul id="exercisePlan"><li>Loading...</li></ul>
            </div>
            <div class="plan-box">
                <h2><i class="fa-brands fa-pagelines"></i> Yoga Recommendations</h2>
                <p id="yogaPlan">Loading...</p> 
            </div>
        </div>
        
        <div class="text-center plan-actions">
            <button class="btn btn-primary" id="refreshPlan"><i class="fa-solid fa-arrows-rotate"></i> Recommend New Plan</button>
            <a href="/dashboard" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i> Back to Dashboard</a>
        </div>
    </div>

    <script>
        // Helper function to render a list or string
        function renderPlan(elementId, data) {
            const element = document.getElementById(elementId);
            if (Array.isArray(data)) {
                // If data is an array (Diet, Exercise), render as list items
                element.innerHTML = data.map(item => `<li>${item}</li>`).join('') || '<li>No specific plan available.</li>';
            } else {
                // If data is a string (Yoga), render as text
                element.innerHTML = data || 'No specific plan available.';
            }
        }
        
        async function fetchHealthPlan(recommendNew = false) {
            const patientId = sessionStorage.getItem('user_id') || 1; // Use session ID or default
            const url = `/api/get_plan/${patientId}?recommend_new=${recommendNew}`;
            
            // Show loading state
            renderPlan('dietPlan', ['Loading...']);
            renderPlan('exercisePlan', ['Loading...']);
            renderPlan('yogaPlan', 'Loading...');

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    renderPlan('dietPlan', ['Error fetching plan.']);
                    return;
                }

                // Render the received data
                renderPlan('dietPlan', data.diet);
                renderPlan('exercisePlan', data.exercise);
                renderPlan('yogaPlan', data.yoga);
                
            } catch (err) {
                console.error(err);
                alert('Connection error while fetching health plan.');
                renderPlan('dietPlan', ['Connection error.']);
            }
        }

        document.getElementById('refreshPlan').addEventListener('click', () => {
            fetchHealthPlan(true);
        });

        // Fetch existing plan on page load
        window.onload = () => {
            fetchHealthPlan(false);
        }
    </script>
    
    <footer class="footer">
        <p>&copy; 2025 CareConnect. All rights reserved | Stay Healthy, Stay Safe</p>
    </footer>
</body>
</html>